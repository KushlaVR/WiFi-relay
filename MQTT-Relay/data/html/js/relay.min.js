var __extends=this&&this.__extends||function(){var n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(n,t){n.__proto__=t}||function(n,t){for(var i in t)t.hasOwnProperty(i)&&(n[i]=t[i])};return function(t,i){function r(){this.constructor=t}n(t,i);t.prototype=i===null?Object.create(i):(r.prototype=i.prototype,new r)}}(),WebUI=function(){function n(){}return n.init=function(){var t=Model.getUrlParameter("setup");n.model=t===undefined?new HomePage:new SetupPage;n.model.init()},n.wifi=function(){n.model=new WifiPage;n.model.init()},n.ask=function(t,i,r){var u;r===void 0&&(r=null);u=$("#questionModal");u.html(n.questionTemplate);var h=$(".modal-title",u),f=$(".modal-text",u),e=$(".btn-yes",u),o=$(".btn-no",u),s=$(".btn-cancel",u);f.html(t);u.addClass("in").attr("style","display:block;opacity:1");e.click(function(){i()});o.click(function(){return r&&r(),u.removeClass("in").removeAttr("style"),!1});s.click(function(){return u.removeClass("in").removeAttr("style"),!1})},n.rooturl="api/",n}(),Model=function(){function n(){this.templates=[];this.elements=[]}return n.getUrlParameter=function(n){for(var u=window.location.search.substring(1),r=u.split("&"),t,i=0;i<r.length;i++)if(t=r[i].split("="),t[0]===n)return t[1]===undefined?!0:decodeURIComponent(t[1]);return undefined},n.prototype.init=function(){var n=$("#questionModal");n.length>0&&(WebUI.questionTemplate=$("#questionModal")[0].innerHTML);Converters.ClockPicker()},n.prototype.fillTemplate=function(n,t){var i=n,r,f,u;for(r in t)for(f=t[r],u="@"+r+"@";i.indexOf(u)>=0;)i=i.replace(u,f);return i},n.prototype.loadFailed=function(n,t){this.updateTime(n);$(".process-list").html("Не вдалось завантажити. <button class'btn btn-primary refresh'>Повторити<\/button>");$(".refresh").click(function(){t&&t()})},n.prototype.updateTime=function(n){n.systime&&$("#systime").html(n.systime)},n.prototype.loadTemplateByName=function(n,t){var i=this,r=n;$.get(WebUI.rooturl+"template?name="+n).done(function(n){return i.templateByNameLoaded(r,n,t)}).fail(function(n){return i.loadFailed(n,i.loadElementsTemplate)})},n.prototype.templateByNameLoaded=function(n,t,i){this.updateTime(t);var r=new keyValue;r.key=n;r.value=t;this.templates.push(r);i()},n.prototype.getTemplate=function(n){for(var i,t=0;t<this.templates.length;t++)if(i=this.templates[t],i.key===n)return i.value;return undefined},n.prototype.allElementsTemplateLoaded=function(n){for(var r=0;r<this.elements.length;r++){var u=this.elements[r],t=u.template,i=void 0;if(!(t===undefined)&&(i=this.getTemplate(t),i===undefined)||(t=u.editingtemplate,!(t===undefined)&&(i=this.getTemplate(t),i===undefined))||(t=u.visual,!(t===undefined)&&(i=this.getTemplate(t),i===undefined)))return this.loadTemplateByName(t,n),!1}return!0},n.prototype.loadElementsTemplate=function(){var n=this,t=this.allElementsTemplateLoaded(function(){return n.loadElementsTemplate()});t!==!1&&(this.allLoaded(),Converters.ConvertAll(),$(".switch-checkbox[data-state='ON']").prop("checked",!0))},n.prototype.allLoaded=function(){},n.prototype.getUrlParameter=function(n){for(var u=window.location.search.substring(1),r=u.split("&"),t,i=0;i<r.length;i++)if(t=r[i].split("="),t[0]===n)return t[1]===undefined?!0:decodeURIComponent(t[1]);return undefined},n}(),HomePage=function(n){function t(){return n!==null&&n.apply(this,arguments)||this}return __extends(t,n),t.prototype.init=function(){n.prototype.init.call(this);this.loadProcesses()},t.prototype.loadProcesses=function(){var n=this;$.get(WebUI.rooturl+"switches").done(function(t,i){return n.ProcessesLoaded(t,i)}).fail(function(t){return n.loadFailed(t,n.loadProcesses)})},t.prototype.ProcessesLoaded=function(n){var i,r,t;for(this.updateTime(n),i=n,r="",t=0;t<i.items.length;t++)this.elements.push(i.items[t]);this.loadElementsTemplate()},t.prototype.allLoaded=function(){for(var i,u,f=this,t="",r=0;r<this.elements.length;r++)i=this.elements[r],i.visual&&(u=this.getTemplate(i.visual),u===undefined?(t+="<li class='nav-item'>",t+=i.name,t+="<\/li>"):t+=this.fillTemplate(u,i));$(".process-list").html(t);n.prototype.allLoaded.call(this);$("img[data-state='ON']").removeClass("light-off");$(".switch-img").click(function(n){return f.switch_img_click(n)});$(".switch-checkbox").change(function(n){return f.switch_checkbox_change(n)})},t.prototype.switch_img_click=function(n){var t=$(".switch-checkbox",$(n.target).closest(".card"));t.data("state")=="ON"?this.turnOff(t.data("switch")):this.turnOn(t.data("switch"))},t.prototype.switch_checkbox_change=function(n){n.target.checked?this.turnOn($(n.target).data("switch")):this.turnOff($(n.target).data("switch"))},t.prototype.turnOn=function(n){if($("#switch_"+n.toString()).data("state")!="ON")return console.log("turn on"),$.post(WebUI.rooturl+"switches?index="+n.toString()+"&state=on").done(function(t){t.systime&&$("#systime").html(t.systime);$("#switch_"+n.toString()).data("state","ON");$("#switch_img_"+n.toString()).removeClass("light-off").addClass("light-on");$("#switch_"+n.toString()).prop("checked",!0)}).fail(function(){$("#switch_"+n.toString()).prop("checked",!1)}),!0},t.prototype.turnOff=function(n){if($("#switch_"+n.toString()).data("state")!="OFF")return console.log("turn off"),$.post(WebUI.rooturl+"switches?index="+n.toString()+"&state=off").done(function(t){t.systime&&$("#systime").html(t.systime);$("#switch_"+n.toString()).data("state","OFF");$("#switch_img_"+n.toString()).removeClass("light-on").addClass("light-off");$("#switch_"+n.toString()).prop("checked",!1)}).fail(function(){$("#switch_"+n.toString()).prop("checked",!0)}),!0},t}(Model),SetupPage=function(n){function t(){return n!==null&&n.apply(this,arguments)||this}return __extends(t,n),t.prototype.init=function(){n.prototype.init.call(this);this.loadTriggers()},t.prototype.loadTriggers=function(){var n=this,t=this.getUrlParameter("index");$.get(WebUI.rooturl+"setup?type=switch&index="+t.toString()).done(function(t,i){return n.TriggersLoaded(t,i)}).fail(function(t){return n.loadFailed(t,n.loadTriggers)})},t.prototype.TriggersLoaded=function(n){var i,r,t;for(this.updateTime(n),i=n,r="",t=0;t<i.items.length;t++)this.elements.push(i.items[t]);this.loadElementsTemplate()},t.prototype.allLoaded=function(){var i=this,u=!0,e=this.getTemplate("newitem"),r,n,t,f;if(e===undefined){u=!1;this.loadTemplateByName("newitem",function(){return i.allLoaded()});return}if(u===!0){for(r="",r+=this.getTemplate("newitem"),n=0;n<this.elements.length;n++)t=this.elements[n],f=this.getTemplate(t.template),r+="<div class='holder' id='trigger_"+t.uid+"' data-index='"+n.toString()+"' data-uid='"+t.uid+"'>"+this.fillTemplate(f,t)+"<\/div>";$(".process-list").html(r);$(".btn-edit").click(function(n){return i.edit(n)});$(".btn-add").click(function(n){return i.add(n)});$(".btn-delete").click(function(n){return i.delete(n)});$(".switch-checkbox[data-state='on']").prop("checked",!0);Converters.ClockPicker()}$(".switch-checkbox[data-state='ON']").prop("checked",!0);$("img[data-state='ON']").removeClass("light-off");Converters.ConvertAll()},t.prototype.add=function(n){var f=this,i,u,e,t,r;if(console.log("add"),i=$(n.target).data("newitem"),u=this.getTemplate(i.editingtemplate),u===undefined){e=n;this.loadTemplateByName(i.editingtemplate,function(){return f.add(e)});return}t=document.createElement("div");t.id="trigger_0";t.className="holder";$(".process-list")[0].appendChild(t);r=$(t);r.data("uid",0);r.data("edit",!0);r.html(this.fillTemplate(u,i));$(".btn-edit").attr("disabled","disabled");$(".btn-save").click(function(n){return f.save(n)});$(".switch-checkbox[data-state='on']").prop("checked",!0);Converters.ConvertAll();Converters.ClockPicker()},t.prototype.edit=function(n){var r=this,t;console.log("edit");t=$(n.target).closest(".holder");t.data("edit",!0);var u=t.data("index"),i=this.elements[u],f=this.getTemplate(i.editingtemplate);t.html(this.fillTemplate(f,i));$(".btn-edit").attr("disabled","disabled");$(".btn-save").click(function(n){return r.save(n)});$(".switch-checkbox[data-state='on']").prop("checked",!0);Converters.ConvertAll();Converters.ClockPicker()},t.prototype.save=function(n){var t,r,u;console.log("save");var f=$(n.target).closest(".holder"),o=$("form",f),i=$("[name]",o),e=WebUI.rooturl+"setup?switch="+this.getUrlParameter("index")+"&uid="+f.data("uid");for(t=0;t<i.length;t++)r=void 0,u=$(i[t]),r=u.hasClass("converter-time")?TimeConverter.ConvertBack(i[t]):u.hasClass("converter-week-days")?WeekDaysConverter.ConvertBack(i[t]):TextConverter.ConvertBack(i[t]),e+="&"+i[t].getAttribute("name")+"="+encodeURIComponent(r);$.get(e).done(function(){location.reload()}).fail(function(n){n.systime&&$("#systime").html(n.systime);alert(n)})},t.prototype.delete=function(n){var i=this,t;console.log("delete");t=n;WebUI.ask("Вилучити тригер зі списку?",function(){return i.onDeleConfirmed(t)})},t.prototype.onDeleConfirmed=function(n){var t=$(n.target).closest(".holder"),r=$("form",t),i=WebUI.rooturl+"setup?switch="+this.getUrlParameter("index")+"&delete="+t.data("uid");$.get(i).done(function(){location.reload()}).fail(function(n){n.systime&&$("#systime").html(n.systime);alert(n)})},t}(Model),WifiPage=function(n){function t(){return n!==null&&n.apply(this,arguments)||this}return __extends(t,n),t.prototype.init=function(){n.prototype.init.call(this);this.loadStationList()},t.prototype.loadStationList=function(){var n=this;$.get(WebUI.rooturl+"wifi").done(function(t,i){return n.StationListLoaded(t,i)}).fail(function(t){return n.loadFailed(t,n.loadStationList)})},t.prototype.StationListLoaded=function(n){var r,u,i,t;for(this.updateTime(n),r=n,u="",i=0;i<r.ssid.length;i++)t=r.ssid[i],t.template="wifi",t.encryption_name=t.encryption=="7"?"-":"***",this.elements.push(t);this.loadElementsTemplate()},t.prototype.allLoaded=function(){for(var t,r,u=this,n="",i=0;i<this.elements.length;i++)t=this.elements[i],r=this.getTemplate(t.template),r===undefined?(n+="<li class='nav-item'>",n+=t.name,n+="<\/li>"):n+=this.fillTemplate(r,t);$(".wifi-list").html(n);$(".wifi-item").on("click",function(n){return u.wifi_item_click(n)})},t.prototype.wifi_item_click=function(n){$("#ssid").val($(".name",n.currentTarget).text());$("#password").focus()},t}(Model),WIFI_list=function(){function n(){}return n}(),Items_list=function(){function n(){}return n}(),keyValue=function(){function n(){}return n}(),Trigger=function(){function n(){}return n}(),Converters=function(){function n(){}return n.ConvertAll=function(){TimeConverter.Convert();TextConverter.Convert();WeekDaysConverter.Convert()},n.ClockPicker=function(){var n=$(".clockpicker");n.clockpicker({placement:"top",autoclose:!0})},n}(),TimeConverter=function(){function n(){}return n.Convert=function(){var t=$(".converter-time").each(function(t,i){var r=$(i),e,u,f;r.data("converted")!=="1"&&(e=i.tagName==="INPUT"?r.val():i.innerHTML,u="",f=parseInt(e,10),u=n.pad(Math.floor(f/60).toString(),2)+":"+n.pad((f%60).toString(),2),r.data("converted","1"),i.tagName==="INPUT"?r.attr("value",u):i.innerHTML=u)})},n.ConvertBack=function(n){var t=$(n),i,r,u;return t.data("converted")==="1"?(i=void 0,i=n.tagName==="INPUT"?t.val():n.innerHTML,r=i.split(":"),u=parseInt(r[0])*60+parseInt(r[1]),u.toString()):t.val()},n.pad=function(n,t){for(var i=n;i.length<(t||2);)i="0"+i;return i},n}(),TextConverter=function(){function n(){}return n.Convert=function(){},n.ConvertBack=function(n){var t=$(n);return t.attr("type")==="checkbox"?t.prop("checked"):t.val()},n}(),WeekDaysConverter=function(){function n(){}return n.Convert=function(){var t=$(".converter-week-days").each(function(t,i){var f=$(i),e,r,o,u;if(f.data("converted")!=="1"){for(e=i.tagName==="INPUT"?f.val():i.innerHTML,r="",o=parseInt(e,10),u=0;u<7;u++)(o&1<<u)!=0&&(r.length>0&&(r+=", "),r+=n.weekday[u]);f.data("converted","1");i.tagName==="INPUT"?f.attr("value",r):i.innerHTML=r}})},n.ConvertBack=function(t){var r=$(t),u,f,e,i,o;if(r.data("converted")==="1"){for(u=void 0,u=t.tagName==="INPUT"?r.val():t.innerHTML,f=u.split(","),e=0,i=0;i<f.length;i++)o=n.weekday.indexOf(f[i].trim()),o>=0&&(e+=1<<o);return e.toString()}return r.val()},n.weekday=["Нд","Пн","Вт","Ср","Чт","Пт","Сб"],n}();